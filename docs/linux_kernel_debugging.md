## Linux Kernel Debugging Skills

### General Debugging

Many debugging infrastructures provided by Linux Kernel that can be enabled as necessary based on which subsystem need to debug.

| Kernel Debug Config Options                          | Description                                                  | Default Value                           |
| ---------------------------------------------------- | ------------------------------------------------------------ | --------------------------------------- |
| CONFIG_DEBUG_USER                                    | When a user space process is killed due to a segfault or illegal instruction, a message will be printed out<br /><br />arch/arm/Kconfig.debug | =Y<br />kernel boot param:user_debug=31 |
| CONFIG_FREE_PAGES_RDONLY                             | Enable this options to mark pages as read only to trigger a fault if any code attempt to write to page on the buddy list. This may have a performance impact.<br /><br />arch/arm/Kconfig.debug | =N                                      |
| CONF_ARM_PTDUMP                                      | Show the kernel page table layout in a debug file.<br /><br />arch/arm/Kconfig.debug | =N                                      |
| CONFIG_ARM_UNWIND                                    | Enables stack unwinding support in the kernel using the info auto generated by the compiler. Kernel size is slightly bigger but no performance impact.<br /><br />arch/arm/Kconfig.debug | =Y                                      |
| CONFIG_DEBUG_SET_MODULE_RONX                         | Set module data as NX and text as RO which prevents module data execution and code manipulation for safety. However it interferes with dynamic kernel tracing.<br /><br />arch/arm/Kconfig.debug | =Y                                      |
| CONFIG_PAGE_POSITIONING,<br />CONFIG_DEBUG_PAGEALLOC | Fills the pages with posion patterns after free_pages() and verifies the pattern before alloc_pages()<br /><br />mm/Kconfig.debug | =N                                      |
| CONFIG_DEBUG_SPINLOCK,<br />CONFIG_DEBUG_MUTEXS      | To catch bad behavior/violations on spinlock and mutex.<br /><br />lib/Kconfig.debug | =N                                      |
| CONFIG_DEBUG_LOCK_ALLOC                              | Lock debugging - Detect incorrect freeing of live locks<br /><br />/lib/Kconfig.debug | =N                                      |
| CONFIG_DEBUG_ATOMIC_SLEEP                            | Various routines which may sleep become noisy if they are called inside atomic sections.<br /><br />/lib/Kconfig.debug | =N                                      |
| CONFIG_DEBUG_HIGHMEM,<br />CONFIG_DEBUG_VM           | Additional debug options for kernel virtual memory management corruption<br /><br />lib/Kconfig.debug | =N                                      |
| CONFIG_SLUB_DEBUG                                    | Puts additional checks to detect corruption of internal kernel memory allocation structures<br /><br />mm/Kconfig.debug | =Y                                      |
| CONFIG_DYNAMIC_DEBUG                                 | Enable dynamic printk() support<br /><br />lib/Kconfig.debug | =Y                                      |
| CONFIG_DEBUG_KMEMLEAK                                | Enable the memory leak detector to trace memory allocation/freeing in kernel. Enabling this option will introduce overhead to memory allocation.<br /><br />lib/Kconfig.debug | =N                                      |
| CONFIG_FTRACE                                        | Enable the kernel tracing infrastructure<br /><br />kernel/trace/Kconfig | =Y                                      |

### Kernel Profiling

Profiling: process of sampling the execution of a program to analyze its performance.

- Linux kernel performance events subsystem
  - CONFIG_PERF_EVENTS=y
  - Hardware performance unit(PMU) registers for various h/w events 
    - Cache-miss
    - Instruction executed
    - Branch-miss 
    - ...and so on
- Two common tools for profiling on Linux
  - oprofile, out-of-kernel userspace tool code
    - CONFIG_OPROFILE=m, CONFIG_PROFILING=y
  - perf, in-tree userspace tool code
  - Both use kernel perf events subsystem

#### Tools

##### perf

A collection of tools for profiling and tracing

- Profiling based on kernel perf events.
- Tracing through Trace points static events & dynamic events.
- Each tool is selected as a subcommand.
- Source code location: tools/perf/.

```
# perf
   annotate        Read perf.data (created by perf record) and display annotated code
   archive         Create archive with object files with build-ids found in perf.data file
   bench           General framework for benchmark suites
   buildid-cache   Manage build-id cache.
   buildid-list    List the buildids in a perf.data file
   diff            Read two perf.data files and display the differential profile
   evlist          List the event names in a perf.data file
   inject          Filter to augment the events stream with additional information
   kmem            Tool to trace/measure kernel memory(slab) properties
   kvm             Tool to trace/measure kvm guest os
   list            List all symbolic event types
   lock            Analyze lock events
   mem             Profile memory accesses
   periodic        Periodically print the performance counters at given rate
   record          Run a command and record its profile into perf.data
   report          Read perf.data (created by perf record) and display the profile
   sched           Tool to trace/measure scheduler properties (latencies)
   script          Read perf.data (created by perf record) and display trace output
   stat            Run a command and gather performance counter statistics
   test            Runs sanity tests.
   timechart       Tool to visualize total system behavior during a workload
   top             System profiling tool.
   trace           strace inspired tool
   probe           Define new dynamic tracepoints

```



[Back to Home](../index.md)